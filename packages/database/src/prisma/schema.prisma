// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-1.1.x", "debian-openssl-1.1.x"]
  output        = "../src/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  USER
  ADMIN
}

model User {
  id              String   @id @default("")
  identityAddress String   @unique
  createdAt       DateTime @default(now())
  accountAddress  String?
  name            String?
  country         String?
  type            UserType @default(USER)
  referralCode    String   @unique
  referredBy      String?
  referredByUser  User?    @relation("Referrer", fields: [referredBy], references: [referralCode])
  blocked         Boolean  @default(false)

  events                     Event[]
  messages                   Message[]
  email                      UserEmail?
  phoneNumber                UserPhoneNumber?
  completedQuestRequirements CompletedQuestRequirement[]
  savedProgress              SavedProgress?
  auditLogs                  Audit[]
  questProgress              QuestProgress[]
  referredUsers              User[]                      @relation("Referrer")
  transactions               TransactionIntent[]
  marketing                  Marketing[]
  referals                   Referral[]
  goldenTicketClaimed        GoldenTicket?               @relation("claimedBy")
  goldenTicketsOwned         GoldenTicket[]              @relation("owner")
}

model UserEmail {
  userId     String  @unique
  email      String  @id @unique
  newsletter Boolean @default(false)
  user       User    @relation(fields: [userId], references: [id])
}

enum ImageType {
  RadMorph
  RadGem
  Card
}

model Image {
  id   String    @id
  url  String
  type ImageType
}

model UserPhoneNumber {
  userId      String   @unique
  phoneNumber String   @id @unique
  createdAt   DateTime @default(now())
  ip          String   @default("")

  user User @relation(fields: [userId], references: [id])

  @@index([ip])
}

enum ReferralAction {
  INC
  DEC
}

model Referral {
  eventId  String         @id @unique
  userId   String
  action   ReferralAction
  xrdValue Decimal

  event Event @relation(fields: [eventId], references: [transactionId])
  user  User  @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Challenge {
  challenge String   @id
  createdAt DateTime @default(now())
}

enum EventStatus {
  WAITING
  PENDING
  ERROR
  COMPLETED
  FAILED_RETRY
  FAILED_PERMANENT
  PAUSED
  CANCELLED
}

model Event {
  transactionId String      @id
  id            String
  userId        String
  questId       String?
  status        EventStatus @default(WAITING)
  createdAt     DateTime    @default(now())
  error         String?
  data          Json        @default("{}")

  user     User       @relation(fields: [userId], references: [id])
  referral Referral[]
}

model Message {
  id        Int       @id @default(autoincrement())
  userId    String
  createdAt DateTime  @default(now())
  seenAt    DateTime?
  data      Json

  user User @relation(fields: [userId], references: [id])

  @@index([userId, seenAt])
}

model Notification {
  notificationId String
  userId         String
  seenAt         DateTime?

  @@id([notificationId, userId])
}

model CompletedQuestRequirement {
  questId       String
  userId        String
  requirementId String
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@id([questId, userId, requirementId])
}

model QuestProgress {
  questId String
  userId  String
  status  QuestStatus @default(IN_PROGRESS)

  user User @relation(fields: [userId], references: [id])

  @@id([questId, userId])
}

model SavedProgress {
  userId   String @id
  questId  String
  progress Int
  user     User   @relation(fields: [userId], references: [id])
}

enum QuestStatus {
  IN_PROGRESS
  REWARDS_DEPOSITED
  REWARDS_CLAIMED
  COMPLETED
}

model Audit {
  transactionId String @id
  userId        String

  date        DateTime  @default(now())
  type        AuditType
  xrdUsdValue Decimal
  xrdPrice    Decimal   @default(1)
  data        Json      @default("{}")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

enum AuditType {
  DIRECT_DEPOSIT
  CLAIMBOX_DEPOSIT
}

model BlockedCountry {
  country     String
  countryCode String  @id
  blocked     Boolean @default(false)
}

model TransactionIntent {
  discriminator String                  @id
  status        TransactionIntentStatus @default(WAITING)
  createdAt     DateTime                @default(now())
  error         String?
  userId        String
  data          Json?
  transactions  SubmittedTransaction[]
  batchId       String?

  user  User                      @relation(fields: [userId], references: [id])
  batch BatchedTransactionIntent? @relation(fields: [batchId], references: [id])

  @@index([status, createdAt])
}

model BatchedTransactionIntent {
  id                 String                  @id
  status             TransactionIntentStatus @default(WAITING)
  createdAt          DateTime                @default(now())
  error              String?
  transactionIntents TransactionIntent[]

  @@index([status, createdAt])
}

enum TransactionIntentStatus {
  WAITING
  PENDING
  ERROR
  COMPLETED
  FAILED_RETRY
  FAILED_PERMANENT
  PAUSED
  CANCELLED
}

model SubmittedTransaction {
  transactionId     String   @id
  transactionIntent String
  status            String
  createdAt         DateTime @default(now())

  transaction TransactionIntent @relation(fields: [transactionIntent], references: [discriminator])
}

model Config {
  key   String @id
  value String
}

model Marketing {
  id           Int     @id @default(autoincrement())
  userId       String
  utm_campaign String?
  utm_medium   String?
  utm_source   String?
  utm_id       String?
  utm_content  String?
  utm_term     String?

  user User @relation(fields: [userId], references: [id])
}

model GoldenTicket {
  id          String             @id
  batchId     String
  ownerId     String
  createdAt   DateTime           @default(now())
  expiresAt   DateTime
  userId      String?            @unique
  claimedAt   DateTime?
  description String?
  status      GoldenTicketStatus @default(CLAIMABLE)

  claimedBy User? @relation("claimedBy", fields: [userId], references: [id])
  owner     User  @relation("owner", fields: [ownerId], references: [id])
}

enum GoldenTicketStatus {
  CLAIMABLE
  CLAIMED
  CLAIMED_INVALID
}
